```{r setup, echo = FALSE, include = FALSE}
library("papaja")
library("knitr") # for knitting things
library("tidyverse") # for all things tidyverse
library("car")
library("lme4")
library("patchwork")
library("effsize")

# these options here change the formatting of how comments are rendered
opts_chunk$set(
  comment = "",
  results = "hold",
  fig.show = "hold")

# set the default ggplot theme 
theme_set(theme_classic())

r_refs("r-references.bib")
r_refs("references/packages.bib")

```

```{r analysis-preferences}
# Seed for random number generation
set.seed(42)
knitr::opts_chunk$set(cache.extra = knitr::rand_seed)
```

```{r combine corpus and behavior data, include = F}
source("../2_combine/2_combine.R") # include triad_omits. TODO: Find a way to also save this.
```

```{r incorporate base freq, eval=F, include = F}
df <- read.csv("../../data/data_USCNVN_ENZHVI.csv")
df.basefreq <- read.csv("../../data/corpus/basefreq_EMV.csv")

#no base frequencies for vietnamese yet
df.basefreq <- df.basefreq %>% select(triad,
                                      cue_basefreq_E, tax_basefreq_E, theme_basefreq_E,
                                      cue_basefreq_M, tax_basefreq_M, theme_basefreq_M,
                                      cue_basefreq_V, tax_basefreq_V, theme_basefreq_V)

df <- left_join(df, df.basefreq, by = "triad")

#replacing any 0 raw counts with epsilon
df <- df %>%
  mutate(cue_basefreq_E = ifelse(cue_basefreq_E == 0, 
                                  .Machine$double.eps, cue_basefreq_E),
         tax_basefreq_E = ifelse(tax_basefreq_E == 0, 
                                  .Machine$double.eps, tax_basefreq_E),
         theme_basefreq_E = ifelse(theme_basefreq_E == 0, 
                                  .Machine$double.eps, theme_basefreq_E),
         cue_basefreq_M = ifelse(cue_basefreq_M == 0, 
                                  .Machine$double.eps, cue_basefreq_M), 
         tax_basefreq_M = ifelse(tax_basefreq_M == 0, 
                                  .Machine$double.eps, tax_basefreq_M),
         theme_basefreq_M = ifelse(theme_basefreq_M == 0, 
                                  .Machine$double.eps, theme_basefreq_M),
         cue_basefreq_V = ifelse(cue_basefreq_V == 0, 
                                  .Machine$double.eps, cue_basefreq_V),
         tax_basefreq_V = ifelse(tax_basefreq_V == 0, 
                                  .Machine$double.eps, tax_basefreq_V), 
         theme_basefreq_V = ifelse(theme_basefreq_V == 0, 
                                  .Machine$double.eps, theme_basefreq_V)
         )
```

```{r calculate cue given match and match given cue proportions, include = F, eval = F}
# for now, calculate specifically in terms of which one they have answered? (theme vs match)
# but maybe do for all languages? 
calculate_cue_given_match <- function(responses_theme, language,
                                      tax_basefreq_E, theme_basefreq_E,
                                      theme_frequency_E, tax_frequency_E,
                                      tax_basefreq_M, theme_basefreq_M,
                                      theme_frequency_M, tax_frequency_M,
                                      tax_basefreq_V, theme_basefreq_V,
                                      theme_frequency_V, tax_frequency_V) {
    ifelse(language == "English",
           ifelse(responses_theme == 1, theme_frequency_E / theme_basefreq_E, tax_frequency_E / tax_basefreq_E),
           ifelse(language == "Mandarin",
                  ifelse(responses_theme == 1, theme_frequency_M / theme_basefreq_M, tax_frequency_M / tax_basefreq_M),
                  NA))
}

calculate_match_given_cue <- function(responses_theme, language,
                                      cue_basefreq_E, theme_frequency_E, tax_frequency_E,
                                      cue_basefreq_M, theme_frequency_M, tax_frequency_M,
                                      cue_basefreq_V, theme_frequency_V, tax_frequency_V) {
    ifelse(language == "English",
           ifelse(responses_theme == 1, theme_frequency_E / cue_basefreq_E, tax_frequency_E / cue_basefreq_E),
           ifelse(language == "Mandarin",
                  ifelse(responses_theme == 1, theme_frequency_M / cue_basefreq_M, tax_frequency_M / cue_basefreq_M),
                  NA))
}

df <- df %>% mutate(cue_given_match = calculate_cue_given_match(
                                          responses_theme, language,
                                          tax_basefreq_E, theme_basefreq_E,
                                          theme_frequency_E, tax_frequency_E,
                                          tax_basefreq_M, theme_basefreq_M,
                                          theme_frequency_M, tax_frequency_M,
                                          tax_basefreq_V, theme_basefreq_V,
                                          theme_frequency_V, tax_frequency_V),
                    match_given_cue = calculate_match_given_cue(
                                          responses_theme, language,
                                          cue_basefreq_E, theme_frequency_E, tax_frequency_E,
                                          cue_basefreq_M, theme_frequency_M, tax_frequency_M,
                                          cue_basefreq_V, theme_frequency_V, tax_frequency_V))

write.csv(df, "../../data/data_USCNVN_ENZHVI_direction.csv")
```

## Does match given cue (intuitive) predict behavior better than cue given match (non-intuitive)?

We are trying to figure out if people's process is more well-modeled by match given cue or cue given match. In other words, are people looking at the cue ("cow") and then judging the matches ("chicken" or "grass")? Or are people looking at the matches first ("chicken") and then seeing if it matches with the cue ("cow") well enough?
```{r loading in the csv with direction so we dont need to go through the previous section, include =F}
df <- read.csv("../../data/data_USCNVN_ENZHVI_direction.csv")
```

We need to run the baseline model again (corresponding corpora predicting responding behavior). And then compare that to the new updated models. 

### English
Baseline model:
```{r US responding predicted by each corpus model raw co-occurrences, warning=FALSE}
# English 
fit.EN_US = glmer(responses_theme ~ theme_freq_prop_E + (1 | subject) + (1 | triad), 
          data = df %>% filter(country == "US", !(triad %in% triads_omit)), 
          family="binomial")
summary(fit.EN_US)
fit.EN_US.anova = Anova(fit.EN_US, type = 3)
```

Intuitive model (cue first): 
```{r}
fit.EN_US_cue_first = glmer(responses_theme ~ theme_freq_prop_E + match_given_cue + (1 | subject) + (1 | triad), 
          data = df %>% filter(country == "US", !(triad %in% triads_omit)), 
          family="binomial")
summary(fit.EN_US_cue_first)
```

Comparing cue-first (intuitive) and base model: Cue-first model fits data better than base model.
```{r}
fit.EN_US_dir_compare_cue_first = anova(fit.EN_US, fit.EN_US_cue_first, type = 3)
fit.EN_US_dir_compare_cue_first
```

Non-intuitive model (match first):
```{r}
fit.EN_US_match_first = glmer(responses_theme ~ theme_freq_prop_E + cue_given_match + (1 | subject) + (1 | triad), 
          data = df %>% filter(country == "US", !(triad %in% triads_omit)), 
          family="binomial")
summary(fit.EN_US_match_first)
```

Comparing match-first (non-intuitive) and base model: Match-first model fits data better than base model.
```{r}
fit.EN_US_dir_compare_match_first = anova(fit.EN_US, fit.EN_US_match_first, type = 3)
fit.EN_US_dir_compare_match_first
```

Comparing match-first (non-intuitive) and cue-first (intuitive) model: Null result?
```{r}
fit.EN_US_dir_compare_cue_vs_match_first = anova(fit.EN_US_cue_first, fit.EN_US_match_first, type = 3)
fit.EN_US_dir_compare_cue_vs_match_first
```

Adding cue given match (cue+match / match) OR match given cue (cue+match / cue) both improve the model significantly over only having thematic frequency prop, even though the additional term does not wipe out the effect of thematic proportion. Comparing between the cue given match and match given cue model yields null result. 

```{r VN responding predicted by each corpus model raw co-occurrences, warning=FALSE, include=F, eval=F}
# English 
fit.EN_VN = glmer(responses_theme ~ theme_freq_prop_E + (1 | subject) + (1 | triad), 
          data = df %>% filter(country == "Vietnam", !(triad %in% triads_omit)), 
          family="binomial")
summary(fit.EN_VN)
fit.EN_VN.anova = Anova(fit.EN_VN, type = 3)

#Vietnamese
fit.VI_VN = glmer(responses_theme ~ theme_freq_prop_V + (1 | subject) + (1 | triad), 
          data = df %>% filter(country == "Vietnam", !(triad %in% triads_omit)), 
          family="binomial")
summary(fit.VI_VN)
fit.VI_VN.anova = Anova(fit.VI_VN, type = 3)

#Mandarin
fit.ZH_VN = glmer(responses_theme ~ theme_freq_prop_M + (1 | subject) + (1 | triad), 
          data = df %>% filter(country == "Vietnam", !(triad %in% triads_omit)), 
          family="binomial")
summary(fit.ZH_VN)
fit.ZH_VN.anova = Anova(fit.ZH_VN, type = 3)
```

### Mandarin
Baseline model:
```{r CN responding predicted by each corpus model raw co-occurrences, warning=FALSE}
#Mandarin
fit.ZH_CN = glmer(responses_theme ~ theme_freq_prop_M + (1 | subject) + (1 | triad), 
          data = df %>% filter(country == "China", !(triad %in% triads_omit)), 
          family="binomial")
summary(fit.ZH_CN)
fit.ZH_CN.anova = Anova(fit.ZH_CN, type = 3)
```

Intuitive model (cue first):
```{r}
fit.ZH_CN_cue_first = glmer(responses_theme ~ theme_freq_prop_M + match_given_cue + (1 | subject) + (1 | triad), 
          data = df %>% filter(country == "China", !(triad %in% triads_omit)), 
          family="binomial")
summary(fit.ZH_CN_cue_first)
```

Comparing cue-first (intuitive) and base model: Cue-first model fits data better than base model.
```{r}
fit.ZH_CN_dir_compare_cue_first = anova(fit.ZH_CN, fit.ZH_CN_cue_first, type = 3)
fit.ZH_CN_dir_compare_cue_first
```

Non-intuitive model (match first):
```{r}
fit.ZH_CN_match_first = glmer(responses_theme ~ theme_freq_prop_M + cue_given_match + (1 | subject) + (1 | triad), 
          data = df %>% filter(country == "China", !(triad %in% triads_omit)), 
          family="binomial")
summary(fit.ZH_CN_match_first)
```

Comparing match-first (non-intuitive) and base model: Match-first model fits data better than base model.
```{r}
fit.ZH_CN_dir_compare_match_first = anova(fit.ZH_CN, fit.ZH_CN_match_first, type = 3)
fit.ZH_CN_dir_compare_match_first
```

Comparing match-first (non-intuitive) and cue-first (intuitive) model: Null result?
```{r}
fit.ZH_CN_dir_compare_cue_vs_match_first = anova(fit.ZH_CN_cue_first, fit.ZH_CN_match_first, type = 3)
fit.ZH_CN_dir_compare_cue_vs_match_first

```
Adding cue given match (cue+match / match) OR match given cue (cue+match / cue) both improve the model significantly over only having thematic frequency prop, even though the additional term does not wipe out the effect of thematic proportion. Comparing between the cue given match and match given cue model yields null result.